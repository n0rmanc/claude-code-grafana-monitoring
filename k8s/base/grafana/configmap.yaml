apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: claude-monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: visualization
data:
  grafana.ini: |
    [analytics]
    check_for_updates = true
    [grafana_net]
    url = https://grafana.net
    [log]
    mode = console
    [paths]
    data = /var/lib/grafana/
    logs = /var/log/grafana
    plugins = /var/lib/grafana/plugins
    provisioning = /etc/grafana/provisioning
    [server]
    root_url = http://localhost:3000/
    [security]
    admin_user = admin
    admin_password = admin

  dashboards.yaml: |
    apiVersion: 1
    providers:
    - name: default
      folder: ""
      type: file
      options:
        path: /var/lib/grafana/dashboards

  datasources.yaml: |
    apiVersion: 1
    datasources:
    - name: Prometheus
      type: prometheus
      access: proxy
      url: http://dev-prometheus:9090
      basicAuth: false
      isDefault: true

  claude-code-dashboard.json: |
    {
        "id": null,
        "uid": "claude-code-monitoring-v9",
        "title": "Claude Code Monitoring (Organized)",
        "tags": ["claude", "code", "monitoring"],
        "timezone": "browser",
        "schemaVersion": 30,
        "version": 1,
        "refresh": "30s",
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 0,
        "links": [],
        "liveNow": false,
        "time": {
          "from": "now/d",
          "to": "now"
        },
        "panels": [
          {
            "id": 100,
            "title": "üí∞ Cost Overview",
            "type": "row",
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
            "collapsed": false
          },
          {
            "id": 4,
            "title": "Daily Cost (Today So Far)",
            "description": "Âæû‰ªäÊó•ÂçàÂ§úÈñãÂßãÂà∞ÁèæÂú®ÁöÑÁ∏ΩÊàêÊú¨",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 10},
                    {"color": "red", "value": 50}
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[$__range]))",
                "legendFormat": "Daily Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 8, "x": 0, "y": 1}
          },
          {
            "id": 5,
            "title": "Cost (Last 24h)",
            "description": "ÈÅéÂéª 24 Â∞èÊôÇÁöÑÊªæÂãïÊàêÊú¨",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "blue", "value": null}]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "none",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[24h]))",
                "legendFormat": "24h Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 8, "x": 8, "y": 1}
          },
          {
            "id": 20,
            "title": "Active Sessions Cost",
            "description": "ÁõÆÂâçÊ¥ªË∫ç sessions ÁöÑÁ¥ØÁ©çÊàêÊú¨",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "purple", "value": null}]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(max by (session_id) (claude_code_claude_code_cost_usage_USD_total))",
                "legendFormat": "Active Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 8, "x": 16, "y": 1}
          },
          {
            "id": 3,
            "title": "API Request Cost Trend",
            "type": "timeseries",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(claude_code_claude_code_cost_usage_USD_total[5m])",
                "legendFormat": "Cost per second"
              }
            ],
            "gridPos": {"h": 6, "w": 24, "x": 0, "y": 5}
          },
          {
            "id": 103,
            "title": "üìà Cost Analysis",
            "type": "row",
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 11},
            "collapsed": false
          },
          {
            "id": 25,
            "title": "Cost by Model",
            "description": "Áï∂Â§©ÂêÑÊ®°ÂûãÁöÑÊàêÊú¨ÂàÜ‰Ωà",
            "type": "piechart",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "green", "value": null}]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "pieType": "pie",
              "tooltip": {"mode": "single"},
              "legend": {
                "displayMode": "visible",
                "placement": "bottom"
              }
            },
            "targets": [
              {
                "expr": "sum by (model) (increase(claude_code_claude_code_cost_usage_USD_total[$__range]))",
                "legendFormat": "{{model}}",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 12}
          },
          {
            "id": 26,
            "title": "Hourly Cost Trend",
            "description": "‰ªäÂ§©ÊØèÂ∞èÊôÇÁöÑÊàêÊú¨Ë∂®Âã¢",
            "type": "timeseries",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "green", "value": null}]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "tooltip": {"mode": "multi"},
              "legend": {
                "displayMode": "visible",
                "placement": "bottom"
              }
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[1h]))",
                "legendFormat": "Cost per hour",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 12}
          },
          {
            "id": 27,
            "title": "Cost Efficiency: $/Line",
            "description": "ÊØèË°åÁ®ãÂºèÁ¢ºÁöÑÂπ≥ÂùáÊàêÊú¨",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 0.01},
                    {"color": "red", "value": 0.05}
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 6
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[$__range])) / (sum(increase(claude_code_claude_code_lines_of_code_count_total[$__range])) > 0)",
                "legendFormat": "Cost per line",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 20}
          },
          {
            "id": 28,
            "title": "Cost Efficiency: $/Commit",
            "description": "ÊØèÂÄã commit ÁöÑÂπ≥ÂùáÊàêÊú¨",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "green", "value": null},
                    {"color": "yellow", "value": 1},
                    {"color": "red", "value": 5}
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[$__range])) / (sum(increase(claude_code_claude_code_commit_count_total[$__range])) > 0)",
                "legendFormat": "Cost per commit",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 20}
          },
          {
            "id": 29,
            "title": "Token Efficiency: Tokens/$",
            "description": "ÊØèÁæéÂÖÉÁç≤ÂæóÁöÑ tokens Êï∏Èáè",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"color": "red", "value": null},
                    {"color": "yellow", "value": 100000},
                    {"color": "green", "value": 500000}
                  ]
                },
                "unit": "short",
                "decimals": 0
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_token_usage_tokens_total[$__range])) / (sum(increase(claude_code_claude_code_cost_usage_USD_total[$__range])) > 0)",
                "legendFormat": "Tokens per dollar",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 20}
          },
          {
            "id": 30,
            "title": "Cost Accumulation",
            "description": "Áï∂Â§©ÊàêÊú¨Á¥ØÁ©çË∂®Âã¢",
            "type": "timeseries",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "blue", "value": null}]
                },
                "unit": "currencyUSD",
                "decimals": 4
              },
              "overrides": []
            },
            "options": {
              "tooltip": {"mode": "single"},
              "legend": {
                "displayMode": "visible",
                "placement": "bottom"
              }
            },
            "targets": [
              {
                "expr": "sum(claude_code_claude_code_cost_usage_USD_total)",
                "legendFormat": "Cumulative Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 20}
          },
          {
            "id": 101,
            "title": "üìä Usage Statistics",
            "type": "row",
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 24},
            "collapsed": false
          },
          {
            "id": 21,
            "title": "Daily Tokens",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "green", "value": null}]
                },
                "unit": "short",
                "decimals": 0
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_token_usage_tokens_total[$__range]))",
                "legendFormat": "Tokens",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 25}
          },
          {
            "id": 22,
            "title": "Daily Code Lines",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "orange", "value": null}]
                },
                "unit": "short",
                "decimals": 0
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_lines_of_code_count_total[$__range]))",
                "legendFormat": "Lines",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 25}
          },
          {
            "id": 23,
            "title": "Daily Commits",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "blue", "value": null}]
                },
                "unit": "short",
                "decimals": 0
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_commit_count_total[$__range]))",
                "legendFormat": "Commits",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 25}
          },
          {
            "id": 24,
            "title": "Active Sessions",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [{"color": "cyan", "value": null}]
                },
                "unit": "short",
                "decimals": 0
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": ["lastNotNull"],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "count(count by (session_id) (claude_code_claude_code_cost_usage_USD_total))",
                "legendFormat": "Sessions",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 25}
          },
          {
            "id": 102,
            "title": "üìà Real-time Activity",
            "type": "row",
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 29},
            "collapsed": false
          },
          {
            "id": 1,
            "title": "Lines of Code Modified",
            "type": "timeseries",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "sum(rate(claude_code_claude_code_lines_of_code_count_total[5m]) * 60)",
                "legendFormat": "Lines per minute"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 30}
          },
          {
            "id": 2,
            "title": "Token Usage Rate",
            "type": "timeseries",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "sum by (type) (rate(claude_code_claude_code_token_usage_tokens_total[5m]) * 60)",
                "legendFormat": "{{type}} tokens/min"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 30}
          }
        ]
      }