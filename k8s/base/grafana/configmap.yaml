apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-config
  namespace: claude-monitoring
  labels:
    app.kubernetes.io/name: grafana
    app.kubernetes.io/component: monitoring
data:
  grafana.ini: |
    [security]
    admin_password = admin

    [users]
    allow_sign_up = false

    [server]
    root_url = %(protocol)s://%(domain)s:%(http_port)s/
    serve_from_sub_path = false

    [database]
    type = sqlite3
    path = grafana.db

    [session]
    provider = memory

    [analytics]
    reporting_enabled = false
    check_for_updates = false

    [log]
    mode = console
    level = info

  datasources.yaml: |
    apiVersion: 1

    datasources:
      - name: Prometheus
        type: prometheus
        access: proxy
        url: http://dev-prometheus:9090
        isDefault: true
        editable: true

  dashboards.yaml: |
    apiVersion: 1

    providers:
      - name: default
        orgId: 1
        folder: ''
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /var/lib/grafana/dashboards

  claude-code-dashboard.json: |
    {
        "id": null,
        "uid": "claude-code-monitoring",
        "title": "Claude Code Monitoring",
        "tags": ["claude", "code", "monitoring"],
        "timezone": "browser",
        "schemaVersion": 30,
        "version": 1,
        "refresh": "30s",
        "editable": true,
        "fiscalYearStartMonth": 0,
        "graphTooltip": 0,
        "links": [],
        "liveNow": false,
        "panels": [
          {
            "id": 1,
            "title": "Session Count",
            "type": "stat",
            "datasource": "Prometheus",
            "targets": [
              {
                "datasource": "Prometheus",
                "expr": "claude_code_claude_code_session_count_total",
                "legendFormat": "Sessions",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 0}
          },
          {
            "id": 2,
            "title": "Lines of Code Modified",
            "type": "stat",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "sum(claude_code_claude_code_lines_of_code_count_total)",
                "legendFormat": "Lines Modified"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 0}
          },
          {
            "id": 3,
            "title": "API Request Cost",
            "type": "graph",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(claude_code_claude_code_cost_usage_USD_total[5m])",
                "legendFormat": "Cost per minute"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 8}
          },
          {
            "id": 4,
            "title": "Token Usage",
            "type": "graph",
            "datasource": "Prometheus",
            "targets": [
              {
                "expr": "rate(claude_code_claude_code_token_usage_tokens_total[5m])",
                "legendFormat": "Tokens per minute"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 16}
          },
          {
            "id": 5,
            "title": "Today's Total Cost",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow", 
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 50
                    }
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 2
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[1d]))",
                "legendFormat": "Today's Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 6, "w": 8, "x": 0, "y": 24}
          },
          {
            "id": 6,
            "title": "Yesterday's Total Cost",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 10
                    },
                    {
                      "color": "red",
                      "value": 50
                    }
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 2
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[1d] offset 1d))",
                "legendFormat": "Yesterday's Cost",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 6, "w": 8, "x": 8, "y": 24}
          },
          {
            "id": 7,
            "title": "Daily Cost Trend (Last 7 Days)",
            "type": "graph",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "barAlignment": 0,
                  "drawStyle": "bars",
                  "fillOpacity": 100,
                  "gradientMode": "none",
                  "hideFrom": {
                    "tooltip": false,
                    "viz": false,
                    "legend": false
                  },
                  "lineInterpolation": "linear",
                  "lineWidth": 1,
                  "pointSize": 5,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "showPoints": "never",
                  "spanNulls": false,
                  "stacking": {
                    "group": "A",
                    "mode": "none"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "currencyUSD",
                "decimals": 2
              },
              "overrides": []
            },
            "options": {
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom",
                "showLegend": true
              },
              "tooltip": {
                "mode": "single",
                "sort": "none"
              }
            },
            "targets": [
              {
                "expr": "sum(increase(claude_code_claude_code_cost_usage_USD_total[1d]))",
                "legendFormat": "Daily Cost",
                "refId": "A",
                "interval": "1d"
              }
            ],
            "gridPos": {"h": 6, "w": 8, "x": 16, "y": 24}
          },
          {
            "id": 8,
            "title": "API Error Rate",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 0.01
                    },
                    {
                      "color": "red",
                      "value": 0.05
                    }
                  ]
                },
                "unit": "percent",
                "decimals": 2
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "rate(claude_code_claude_code_api_error_total[5m]) / rate(claude_code_claude_code_api_request_total[5m]) * 100",
                "legendFormat": "Error Rate",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 30}
          },
          {
            "id": 9,
            "title": "Active Sessions",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    },
                    {
                      "color": "yellow",
                      "value": 5
                    },
                    {
                      "color": "red",
                      "value": 10
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "claude_code_claude_code_active_session_count",
                "legendFormat": "Active Sessions",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 30}
          },
          {
            "id": 10,
            "title": "Git Commits",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(claude_code_claude_code_git_commit_count_total)",
                "legendFormat": "Total Commits",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 30}
          },
          {
            "id": 11,
            "title": "Pull Requests",
            "type": "stat",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "options": {
              "colorMode": "value",
              "graphMode": "area",
              "justifyMode": "auto",
              "orientation": "auto",
              "reduceOptions": {
                "calcs": [
                  "lastNotNull"
                ],
                "fields": "",
                "values": false
              },
              "text": {},
              "textMode": "auto"
            },
            "targets": [
              {
                "expr": "sum(claude_code_claude_code_pull_request_count_total)",
                "legendFormat": "Total PRs",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 30}
          },
          {
            "id": 12,
            "title": "API Request Latency",
            "type": "graph",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "barAlignment": 0,
                  "drawStyle": "line",
                  "fillOpacity": 10,
                  "gradientMode": "none",
                  "hideFrom": {
                    "tooltip": false,
                    "viz": false,
                    "legend": false
                  },
                  "lineInterpolation": "linear",
                  "lineWidth": 1,
                  "pointSize": 5,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "showPoints": "never",
                  "spanNulls": false,
                  "stacking": {
                    "group": "A",
                    "mode": "none"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "s"
              },
              "overrides": []
            },
            "options": {
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom",
                "showLegend": true
              },
              "tooltip": {
                "mode": "single",
                "sort": "none"
              }
            },
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(claude_code_claude_code_api_request_duration_seconds_bucket[5m]))",
                "legendFormat": "50th percentile",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.95, rate(claude_code_claude_code_api_request_duration_seconds_bucket[5m]))",
                "legendFormat": "95th percentile",
                "refId": "B"
              },
              {
                "expr": "histogram_quantile(0.99, rate(claude_code_claude_code_api_request_duration_seconds_bucket[5m]))",
                "legendFormat": "99th percentile",
                "refId": "C"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 0, "y": 34}
          },
          {
            "id": 13,
            "title": "Tool Usage Over Time",
            "type": "graph",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "barAlignment": 0,
                  "drawStyle": "line",
                  "fillOpacity": 10,
                  "gradientMode": "none",
                  "hideFrom": {
                    "tooltip": false,
                    "viz": false,
                    "legend": false
                  },
                  "lineInterpolation": "linear",
                  "lineWidth": 1,
                  "pointSize": 5,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "showPoints": "never",
                  "spanNulls": false,
                  "stacking": {
                    "group": "A",
                    "mode": "none"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "short"
              },
              "overrides": []
            },
            "options": {
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom",
                "showLegend": true
              },
              "tooltip": {
                "mode": "multi",
                "sort": "none"
              }
            },
            "targets": [
              {
                "expr": "sum by (tool_name) (rate(claude_code_claude_code_code_edit_tool_decision_total[5m]) * 60)",
                "legendFormat": "{{tool_name}}",
                "refId": "A"
              }
            ],
            "gridPos": {"h": 8, "w": 12, "x": 12, "y": 34}
          },
          {
            "id": 14,
            "title": "Session Duration Distribution",
            "type": "graph",
            "datasource": "Prometheus",
            "fieldConfig": {
              "defaults": {
                "custom": {
                  "axisLabel": "",
                  "axisPlacement": "auto",
                  "barAlignment": 0,
                  "drawStyle": "bars",
                  "fillOpacity": 100,
                  "gradientMode": "none",
                  "hideFrom": {
                    "tooltip": false,
                    "viz": false,
                    "legend": false
                  },
                  "lineInterpolation": "linear",
                  "lineWidth": 1,
                  "pointSize": 5,
                  "scaleDistribution": {
                    "type": "linear"
                  },
                  "showPoints": "never",
                  "spanNulls": false,
                  "stacking": {
                    "group": "A",
                    "mode": "none"
                  },
                  "thresholdsStyle": {
                    "mode": "off"
                  }
                },
                "mappings": [],
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {
                      "color": "green",
                      "value": null
                    }
                  ]
                },
                "unit": "s"
              },
              "overrides": []
            },
            "options": {
              "legend": {
                "calcs": [],
                "displayMode": "list",
                "placement": "bottom",
                "showLegend": true
              },
              "tooltip": {
                "mode": "single",
                "sort": "none"
              }
            },
            "targets": [
              {
                "expr": "histogram_quantile(0.50, rate(claude_code_claude_code_session_duration_seconds_bucket[5m]))",
                "legendFormat": "Median duration",
                "refId": "A"
              },
              {
                "expr": "histogram_quantile(0.90, rate(claude_code_claude_code_session_duration_seconds_bucket[5m]))",
                "legendFormat": "90th percentile",
                "refId": "B"
              }
            ],
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 42}
          }
        ],
        "time": {
          "from": "now-3h",
          "to": "now"
        }
    }